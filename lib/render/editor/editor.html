<link href="./gs-element-blockly.html" rel="import"/>
<link href="./gobstones-code-runner.html" rel="import"/>

<dom-module id="mu-gobstones-custom-editor">
  <template>
    <gs-element-blockly read-only="{{readOnly}}" id="blocklyElement"
                        media="https://github.com/Program-AR/blockly-package/raw/v0.0.15/media/"></gs-element-blockly>
    <gs-element-blockly id="blocklyTmp" style="display: none"
                        media="https://github.com/Program-AR/blockly-package/raw/v0.0.15/media/"></gs-element-blockly>
  </template>

  <script>
    Polymer({
      is: 'mu-gobstones-custom-editor',
      properties: {
        readOnly: {
          type: Boolean,
          value: false
        },
        startEmpty: {
          type: Boolean,
          default: false
        }
      },

      attached: function () {
        var self = this;

        function setBlocklyColors() {
          if (typeof Blockly === 'undefined' || !Blockly.CUSTOM_COLORS) return setTimeout(setBlocklyColors, 50);
          Blockly.HSV_SATURATION = 0.64;
          Blockly.HSV_VALUE = 1;

          Blockly.MUMUKI_COLORS = {
            pink: 346,
            blue: 204,
            yellow: 40
          };

          Blockly.Msg.MATH_HUE = Blockly.MUMUKI_COLORS.blue;
          Blockly.CUSTOM_COLORS.literalExpression = Blockly.MUMUKI_COLORS.blue;

          Blockly.CUSTOM_COLORS.program = Blockly.MUMUKI_COLORS.pink;
          Blockly.CUSTOM_COLORS.interactiveProgram = Blockly.MUMUKI_COLORS.pink;
          Blockly.CUSTOM_COLORS.interactiveBinding = Blockly.MUMUKI_COLORS.pink;

          Blockly.CUSTOM_COLORS.controlStructure = Blockly.MUMUKI_COLORS.yellow;
          Blockly.CUSTOM_COLORS.primitiveCommand = Blockly.MUMUKI_COLORS.yellow;
          Blockly.CUSTOM_COLORS.complete = Blockly.MUMUKI_COLORS.yellow;
          Blockly.CUSTOM_COLORS.expression = Blockly.MUMUKI_COLORS.yellow;
          Blockly.CUSTOM_COLORS.assignation = Blockly.MUMUKI_COLORS.yellow;
        };

        function updateFields() {
          var blockly = self.getBlockly();
          var editorValue = $("#mu-custom-editor-value")[0];
          if (editorValue) {
            editorValue.value = blockly.workspaceXml;
          }
          if (typeof angular !== 'undefined') {
            angular.element(editorValue).triggerHandler("change");
          }

          var submit = $("kids-submit-button")[0];
          if (submit && submit.$.runner.isRunning) {
            submit.$.runner.stop();
          }
        };

        function setTrashPosition() {
          var width = $('#blocklyDiv').width() - 68;
          var height = $('#blocklyDiv').height() - 210;
          $('.blocklyTrash').css("transform", `translate(${width}px, ${height}px)`);
          $('.blocklyTrash').css("display", "unset");
        };

        var setTrashTimeout;

        function localOnResize() {
          clearTimeout(setTrashTimeout);
          setTrashTimeout = setTimeout(function() {
            setTrashPosition();
          });
        };

        function triggerResizeOnContextModalClose() {
          $('#kids-context, #kids-results').on('hidden.bs.modal shown.bs.modal', function () {
            localOnResize();
          })
        };

        function relocateTrash(blockly) {
          blockly.workspace.trashcan.bottom_ = 150; //Setting vertical position programmatically to adjust the draggable area
          $(window).resize(function() {
            localOnResize();
          });
          triggerResizeOnContextModalClose();
        };

        function initialize() {
          var blockly = self.getBlockly();
          setTimeout(function() {
            if (!blockly || !blockly.workspace) return initialize();

            relocateTrash(blockly);

            var teacherCode = self.getTeacherCode();
            if (teacherCode) {
              setTimeout(function() {
                var actions = new Parser().getActionsFromSource(teacherCode);
                blockly.primitiveProcedures = actions.procedureDeclarations;
                blockly.primitiveFunctions = actions.functionDeclarations;
              });
            }

            self._setInitialXml(blockly);

            var value = $("#mu-custom-editor-value")[0].value;
            if (value) {
              blockly.workspaceXml = value;
            } else {
              if (self.startEmpty) {
                blockly.workspaceXml = "<xml></xml>";
              }
            }

            localOnResize();

            blockly._onresize();
            blockly.workspace.addChangeListener(updateFields);
            updateFields();
          }, 50);
        };

        setBlocklyColors();
        initialize();
      },

      getBlockly: function () {
        return this.$.blocklyElement;
      },

      getStudentCode: function () {
        return this
          .getBlockly()
          .generateCode({withRegions: true, clearErrors: false});
      },

      getStudentXml: function () {
        return $("#mu-custom-editor-value")[0].value || "";
      },

      getTeacherCode: function () {
        var teacherXml = $("#mu-custom-editor-extra")[0];
        if (!teacherXml || !teacherXml.value) return;
        this.$.blocklyTmp.workspaceXml = teacherXml.value;
        return this.$.blocklyTmp.generateCode();
      },

      _setInitialXml: function (blockly) {
        var editorDefaultContent = $("#mu-custom-editor-default-value")[0];
        if(editorDefaultContent && editorDefaultContent.value) {
          blockly.initialXml = editorDefaultContent.value;
        } else {
          blockly.initialXml = blockly.workspaceXml;
        }
      }

    });
  </script>
</dom-module>

<dom-module id="waiting-spinner">
  <style>
    .spinner {
      width: 60px;
      height: 60px;
    }

    .double-bounce1, .double-bounce2 {
      width: 100%;
      height: 100%;
      border-radius: 50%;
      background-color: #ff4081;
      opacity: 0.6;
      position: absolute;
      top: 0;
      left: 0;

      -webkit-animation: sk-bounce 2.0s infinite ease-in-out;
      animation: sk-bounce 2.0s infinite ease-in-out;
    }

    .double-bounce2 {
      -webkit-animation-delay: -1.0s;
      animation-delay: -1.0s;
    }

    @-webkit-keyframes sk-bounce {
      0%, 100% {
        -webkit-transform: scale(0.0)
      }
      50% {
        -webkit-transform: scale(1.0)
      }
    }

    @keyframes sk-bounce {
      0%, 100% {
        transform: scale(0.0);
        -webkit-transform: scale(0.0);
      }
      50% {
        transform: scale(1.0);
        -webkit-transform: scale(1.0);
      }
    }
  </style>

  <template>
    <div class="spinner">
      <div class="double-bounce1"></div>
      <div class="double-bounce2"></div>
    </div>
  </template>

  <script>
    Polymer({
      is: "waiting-spinner"
    });
  </script>
</dom-module>


<dom-module id="kids-reset-button">

  <template>
    <style>
    </style>

    <div>
      <paper-fab id="gbsResetButton"
                 icon="av:replay"
                 on-click="_onButtonClick"
      ></paper-fab>
    </div>
  </template>

  <script>
    Polymer({
      is: 'kids-reset-button',

      _onButtonClick: function () {
        var blockly = this._getBlockly();
        blockly.workspaceXml = blockly.initialXml;
      },

      _getBlockly: function () {
        return this._getEditor().getBlockly();
      },

      _getEditor: function () {
        return $("mu-gobstones-custom-editor")[0];
      }
    });
  </script>
</dom-module>

<dom-module id="kids-submit-button">
  <style>
    .hidden {
      visibility: hidden;
    }

    .visible {
      visibility: visible;
    }

    .spinner {
      position: absolute;
      top: 0;
      left: 0;
      transform: translate(-2px, -2px);
    }
  </style>

  <template>
    <div style="position: relative">
      <gobstones-code-runner id="runner" class$="{{_getSubmitCss(isWaiting)}}"></gobstones-code-runner>
      <waiting-spinner class$="spinner {{_getSpinnerCss(isWaiting)}}"></waiting-spinner>
    </div>
  </template>

  <script>
    Polymer({
      is: "kids-submit-button",
      listeners: {
        "gbs-run-request": "_onRunRequest",
        "gbs-stop": "_onStop",
        "gbs-reset-state": "_onResetState"
      },
      properties: {
        serverPromise: Object,
        serverResponse: Object,
        isWaiting: {
          type: Boolean,
          value: false
        }
      },

      ready: function () {
        var self = this;
        function setInitialState() {
          var initialBoard = self._getTargetBoard();
          if (!initialBoard.size) return setTimeout(setInitialState, 50);

          self.initialState = {
            size: initialBoard.size,
            table: initialBoard.table,
            header: initialBoard.header
          };
        }

        setInitialState();
      },

      _onRunRequest: function (event) {
        var self = this;
        var controller = event.detail;

        var editor = this._getEditor();
        var xml = editor.getStudentXml();
        var code = editor.getStudentCode();
        var teacherCode = editor.getTeacherCode() || "";
        var finalBoard = this._getTargetBoard();
        var solution = {content: xml};
        var executionSpeed = 2;

        this._cleanState();
        this._cleanErrors(finalBoard);

        var promise = new mumuki.bridge.Laboratory()
          .runTests(solution)
          .then(function(results) {
            if (promise !== self.serverPromise) return;

            self._onRemoteExecutionStop(results)
          });
        this.serverPromise = promise;

        controller.start({
          initialState: this.initialState,
          code: {
            main: code,
            library: "",
            teacher: teacherCode
          }
        }, {
          onResult: function(state, fullState) {
            var region = self._getLastRegion(fullState);
            if (region) self._highlight(region);

            self._updateBoard(state, finalBoard);
          },
          onCompilationError: function(error) {
            var region = error.on.region;
            if (region) self._showError(region, error);
          }
        }, executionSpeed);
      },

      _onStop: function (event) {
        var reason = event.detail;

        if (reason === "end") {
          this._onLocalExecutionStop();
          this._toggleInitialState();
          this.$.runner.isDirty = true;
        }
        else this.serverPromise = undefined;
      },

      _onLocalExecutionStop: function () {
        if (!this.serverResponse) this.isWaiting = true;
        else this._onExecutionStop(this.serverResponse);
      },

      _onRemoteExecutionStop: function (serverResponse) {
        this.serverResponse = serverResponse;

        if (!this.$.runner.isRunning) this._onExecutionStop(serverResponse);
      },

      _onExecutionStop: function (data) {
        this._cleanState();
        mumuki.showKidsResult(data);
      },

      _updateBoard: function (state, finalBoard) {
        var error = state.error;
        var table = state.table;
        var head = state.head;

        finalBoard.boom = error != null;

        if (error) {
          var region = this._getLastRegion(error.on);
          if (region) this._showError(region, error);
        } else {
          finalBoard.update(table, head);
        }
      },

      _highlight: function (region) {
        this._getBlockly().highlightBlock(region);
      },

      _showError: function (region, error) {
        this._getBlockly().showBlockError(region, error.message);
      },

      _cleanState: function () {
        this.serverPromise = undefined;
        this.serverResponse = undefined;
        this.isWaiting = false;
      },

      _cleanErrors: function (finalBoard) {
        this._getBlockly().workspace.removeBlockErrors();
        finalBoard.boom = false;
      },

      _getLastRegion: function (context) {
        if(!context) context = {};
        var regionStack = context.regionStack;
        return regionStack && regionStack.filter(function(it){ return it }).slice(-1)[0];
      },

      _getBlockly: function () {
        return this._getEditor().getBlockly();
      },

      _getEditor: function () {
        return $("mu-gobstones-custom-editor")[0];
      },

      _getTargetBoard: function () {
        return $(".mu-kids-gbs-board-initial gs-board")[0];
      },

      _getSubmitCss: function (isWaiting) {
        return isWaiting ? "hidden" : "visible";
      },

      _getSpinnerCss: function (isWaiting) {
        return isWaiting ? "visible" : "hidden";
      },

      _resetBoard: function () {
        var initialState = this.initialState;
        var initialBoard = this._getTargetBoard();
        initialBoard.update(initialState.table, initialState.header);
        initialBoard.boom = false;
      },

      _onResetState: function () {
        this._getBlockly().workspace.removeBlockErrors();
        this._resetBoard();
        this._toggleInitialState();
      },

      _toggleInitialState: function () {
        $("#mu-initial-state-text").toggle();
        $("#mu-actual-state-text").toggle();
      }
    });
  </script>
</dom-module>

<dom-module id="gs-attire">
  <script>
    Polymer({
      is: 'gs-attire',
      properties: {
        attireUrl: Object,
        observer: '_attireChanged'
      },

      attached: function () {
        this._setAttire();
      },

      _attireChanged: function () {
        this._setAttire();
      },
      
      _setAttire: function () {
        $.getJSON(this.attireUrl, function (attire) {
          GobstonesBoard && GobstonesBoard.setDefaultAttire(attire);
        });
      }
    });
  </script>
</dom-module>

<dom-module id="gs-toolbox">
  <script>
    Polymer({
      is: 'gs-toolbox',
      properties: {
        toolboxUrl: Object,
        observer: '_toolboxChanged'
      },

      attached: function () {
        this._setToolbox();
      },

      _toolboxChanged: function () {
        this._setToolbox();
      },

      _setToolbox: function () {
        $.get(this.toolboxUrl, function (toolboxXml) {
          var blockly = $("mu-gobstones-custom-editor")[0].getBlockly();
          blockly.setDefaultToolbox(toolboxXml);
        });
      }
    });
  </script>
</dom-module>
